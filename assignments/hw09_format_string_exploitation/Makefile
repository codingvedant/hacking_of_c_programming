# Makefile for hw9 - builds 32-bit SUID binary for format string exploitation
# Demonstrates privilege escalation via format string vulnerability

CC = gcc
CFLAGS = -m32 -fno-stack-protector -z execstack -no-pie
TARGET = vuln
PYTHON = python3

all: $(TARGET)

$(TARGET): src/vuln.c
	$(CC) $(CFLAGS) src/vuln.c -o $(TARGET)

# Setup SUID privileges (requires root)
setup-suid: $(TARGET)
	@echo "Setting up SUID privileges (requires sudo):"
	sudo chown root:root $(TARGET)
	sudo chmod u+s $(TARGET)
	@echo "SUID setup complete. Binary now has root privileges."

# Remove SUID privileges
remove-suid: $(TARGET)
	@echo "Removing SUID privileges:"
	sudo chown $$USER:$$USER $(TARGET)
	sudo chmod u-s $(TARGET)
	@echo "SUID privileges removed."

run: $(TARGET)
	./$(TARGET) "test"

exploit: $(TARGET)
	@echo "Running format string exploit (requires SUID setup):"
	$(PYTHON) src/exploit.py

# Disable ASLR (requires root)
disable-aslr:
	@echo "Disabling ASLR (requires sudo):"
	sudo sh -c "echo 0 > /proc/sys/kernel/randomize_va_space"
	@echo "ASLR disabled. Current value:"
	cat /proc/sys/kernel/randomize_va_space

# Re-enable ASLR (requires root)
enable-aslr:
	@echo "Re-enabling ASLR (requires sudo):"
	sudo sh -c "echo 2 > /proc/sys/kernel/randomize_va_space"
	@echo "ASLR enabled. Current value:"
	cat /proc/sys/kernel/randomize_va_space

debug: $(TARGET)
	gdb -q ./$(TARGET)

# Find function addresses
find-addresses: $(TARGET)
	@echo "Finding function addresses:"
	objdump -t $(TARGET) | grep -E "(target_function|main|vulnerable_function)"

# Test format string offset
test-offset: $(TARGET)
	@echo "Testing format string offset (should show 41414141):"
	./$(TARGET) "AAAA%7\$x"

clean:
	rm -f $(TARGET) *.o

.PHONY: all setup-suid remove-suid run exploit disable-aslr enable-aslr debug find-addresses test-offset clean

