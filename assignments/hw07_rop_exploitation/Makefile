# Makefile for hw7 - builds 32-bit binary for ROP exploitation
# Demonstrates bypassing NX protection using code reuse

CC = gcc
CFLAGS = -m32 -g -no-pie -mpreferred-stack-boundary=2 -fno-pic -fno-stack-protector
TARGET = rop
PYTHON = python3

all: $(TARGET)

$(TARGET): src/rop.c
	$(CC) $(CFLAGS) src/rop.c -o $(TARGET)

run: $(TARGET)
	./$(TARGET)

exploit: $(TARGET)
	@echo "Running ROP exploit:"
	$(PYTHON) src/exploit.py

debug: $(TARGET)
	gdb -q ./$(TARGET)

# Disable ASLR (requires root)
disable-aslr:
	@echo "Disabling ASLR (requires sudo):"
	sudo sh -c "echo 0 > /proc/sys/kernel/randomize_va_space"
	@echo "ASLR disabled. Current value:"
	cat /proc/sys/kernel/randomize_va_space

# Re-enable ASLR (requires root)
enable-aslr:
	@echo "Re-enabling ASLR (requires sudo):"
	sudo sh -c "echo 2 > /proc/sys/kernel/randomize_va_space"
	@echo "ASLR enabled. Current value:"
	cat /proc/sys/kernel/randomize_va_space

# Find /bin/sh string address
find-string: $(TARGET)
	@echo "Finding /bin/sh string address:"
	ropper -f $(TARGET) --string "/bin/sh" 2>/dev/null || \
	objdump -s -j .data $(TARGET) | grep -A1 "/bin/sh"

# Disassemble gadgets
disasm: $(TARGET)
	@echo "Disassembling gogodaaget function:"
	objdump -d $(TARGET) | grep -A 30 "gogodaaget"

clean:
	rm -f $(TARGET) *.o

.PHONY: all run exploit debug disable-aslr enable-aslr find-string disasm clean

